# Caddyfile for Homelab Reverse Proxy
# Managed by Ansible - DO NOT EDIT MANUALLY

# Global options
{
    # Let's Encrypt email for certificate notifications
    email {{ letsencrypt_email }}

    log {
        output file /var/log/caddy/access.log
        format console
    }
}

# Enable ACME DNS challenge for all sites
(tls_dns) {
    tls {
        dns porkbun {
            api_key {env.DNS_API_KEY}
            api_secret_key {env.DNS_SECRET_KEY}
        }
    }
}

# Jellyfin Media Server
{{ jellyfin_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:8096 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# N8N Workflow Automation
{{ n8n_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:5678 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Portainer Container Management
{{ portainer_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:9444 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            tls_insecure_skip_verify
        }
    }
}

# Uptime Kuma Monitoring
{{ uptime_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:3001 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# PiHole Admin Interface
{{ pihole_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['pihole']['ansible_host'] }}:80 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Netdata Monitoring
{{ netdata_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:19999 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

{% if immich_enabled | default(true) %}
# Immich Photo Management
{{ immich_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:2283 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# ImmichFrame - Digital Photo Frame
{{ immichframe_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:8701 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
{% endif %}

# TrueNAS Storage
{{ truenas_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['truenas']['ansible_host'] }}:80 {
        header_up Host {{ truenas_url }}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto https
    }
    header Location "http://{{ hostvars['truenas']['ansible_host'] }}:80" "https://{{ truenas_url }}"
    header Location "http://{{ hostvars['truenas']['ansible_host'] }}" "https://{{ truenas_url }}"
}

{% if arr_stack_enabled | default(true) %}
# ===========================================
# ARR STACK - Media Automation
# ===========================================

# Jellyseerr - Media Request Interface
{{ jellyseerr_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:5055 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Sonarr - TV Show Manager
{{ sonarr_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:8989 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Radarr - Movie Manager
{{ radarr_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:7878 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Prowlarr - Indexer Manager
{{ prowlarr_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:9696 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# qBittorrent - Download Client
{{ qbittorrent_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:8080 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
{% endif %}
