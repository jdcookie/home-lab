# Caddyfile for Homelab Reverse Proxy
# Managed by Ansible - DO NOT EDIT MANUALLY

# Global options
{
    # Let's Encrypt email for certificate notifications
    email {{ letsencrypt_email }}

    log {
        output file /var/log/caddy/access.log
        format console
    }
}

# Enable ACME DNS challenge for all sites
(tls_dns) {
    tls {
        dns porkbun {
            api_key {env.DNS_API_KEY}
            api_secret_key {env.DNS_SECRET_KEY}
        }
    }
}

# Authentik SSO
{{ authentik_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:9000 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Jellyfin Media Server
{{ jellyfin_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:8096 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# N8N Workflow Automation
{{ n8n_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:5678 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Portainer Container Management
{{ portainer_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:9444 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        transport http {
            tls_insecure_skip_verify
        }
    }
}

# Uptime Kuma Monitoring
{{ uptime_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:3001 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# PiHole Admin Interface
{{ pihole_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['pihole']['ansible_host'] }}:80 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Netdata Monitoring
{{ netdata_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['docker-services']['ansible_host'] }}:19999 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}

# TrueNAS Storage
{{ truenas_url }} {
    import tls_dns
    reverse_proxy {{ hostvars['truenas']['ansible_host'] }}:80 {
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
}
