---
# PiHole role - install and configure PiHole DNS

- name: Install PiHole dependencies
  apt:
    name:
      - curl
      - ca-certificates
      - git
      - iproute2
      - whiptail
    state: present
    update_cache: yes

- name: Create PiHole directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/pihole
    - /etc/dnsmasq.d

- name: Check if PiHole is installed
  stat:
    path: /usr/local/bin/pihole
  register: pihole_installed

- name: Create PiHole unattended install config
  copy:
    content: |
      PIHOLE_INTERFACE=eth0
      PIHOLE_DNS_1={{ homelab_dns_secondary }}
      PIHOLE_DNS_2=8.8.8.8
      QUERY_LOGGING=true
      INSTALL_WEB_SERVER=true
      INSTALL_WEB_INTERFACE=true
      LIGHTTPD_ENABLED=true
      CACHE_SIZE=10000
      DNS_FQDN_REQUIRED=true
      DNS_BOGUS_PRIV=true
      DNSMASQ_LISTENING=local
      WEBPASSWORD={{ vault_pihole_password | default('changeme') | hash('sha256') | hash('sha256') }}
    dest: /etc/pihole/setupVars.conf
    mode: '0644'
  when: not pihole_installed.stat.exists

- name: Download PiHole installer
  get_url:
    url: https://install.pi-hole.net
    dest: /tmp/pihole-install.sh
    mode: '0755'
  when: not pihole_installed.stat.exists

- name: Install PiHole unattended
  command: /tmp/pihole-install.sh --unattended
  when: not pihole_installed.stat.exists
  notify: restart pihole-FTL

- name: Add custom DNS records (PiHole v6+)
  command: "/usr/local/bin/pihole dns add {{ item.domain }} {{ item.ip }}"
  loop:
    - { domain: "proxmox.{{ homelab_domain }}", ip: "{{ hostvars['pve']['ansible_host'] }}" }
    - { domain: "{{ pihole_url }}", ip: "{{ hostvars['pihole']['ansible_host'] }}" }
    - { domain: "{{ caddy_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "{{ authentik_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "{{ jellyfin_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "{{ n8n_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "{{ portainer_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "{{ uptime_url }}", ip: "{{ hostvars['caddy']['ansible_host'] }}" }
    - { domain: "docker.{{ homelab_domain }}", ip: "{{ hostvars['docker-services']['ansible_host'] }}" }
  register: dns_result
  changed_when: "'already exists' not in dns_result.stderr"
  failed_when: false

- name: Configure PiHole local DNS domain
  copy:
    content: |
      domain={{ homelab_domain }}
      expand-hosts
    dest: /etc/dnsmasq.d/02-homelab.conf
    mode: '0644'
  notify: restart pihole-FTL

- name: Ensure PiHole-FTL service is enabled
  systemd:
    name: pihole-FTL
    enabled: yes
    state: started
