---
# Caddy role - install and configure Caddy reverse proxy

- name: Install dependencies
  apt:
    name:
      - debian-keyring
      - debian-archive-keyring
      - apt-transport-https
      - curl
      - gnupg
      - tar
    state: present
    update_cache: yes

- name: Check if custom Caddy exists
  stat:
    path: /usr/local/bin/caddy
  register: custom_caddy

- name: Download Caddy with Porkbun plugin from custom build
  get_url:
    url: "https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com%2Fcaddy-dns%2Fporkbun"
    dest: /tmp/caddy
    mode: '0755'
  when: not custom_caddy.stat.exists

- name: Move Caddy to /usr/local/bin
  copy:
    src: /tmp/caddy
    dest: /usr/local/bin/caddy
    remote_src: yes
    mode: '0755'
    owner: root
    group: root
  when: not custom_caddy.stat.exists

- name: Remove temporary Caddy download
  file:
    path: /tmp/caddy
    state: absent

- name: Create Caddy user
  user:
    name: caddy
    system: yes
    shell: /usr/sbin/nologin
    home: /var/lib/caddy
    create_home: yes

- name: Create Caddy log directory
  file:
    path: /var/log/caddy
    state: directory
    mode: '0755'
    owner: caddy
    group: caddy

- name: Create Caddy config directory
  file:
    path: /etc/caddy
    state: directory
    mode: '0755'

- name: Set Caddy log directory ownership
  file:
    path: /var/log/caddy
    state: directory
    owner: caddy
    group: caddy
    mode: '0755'

- name: Create Caddy environment file
  copy:
    dest: /etc/caddy/caddy.env
    content: |
      DNS_API_KEY={{ dns_api_key }}
      DNS_SECRET_KEY={{ dns_secret_key }}
    mode: '0600'
    owner: caddy
    group: caddy

- name: Create Caddy systemd service
  copy:
    dest: /etc/systemd/system/caddy.service
    content: |
      [Unit]
      Description=Caddy
      Documentation=https://caddyserver.com/docs/
      After=network.target network-online.target
      Requires=network-online.target

      [Service]
      Type=notify
      User=caddy
      Group=caddy
      EnvironmentFile=/etc/caddy/caddy.env
      ExecStart=/usr/local/bin/caddy run --environ --config /etc/caddy/Caddyfile
      ExecReload=/usr/local/bin/caddy reload --config /etc/caddy/Caddyfile --force
      TimeoutStopSec=5s
      LimitNOFILE=1048576
      LimitNPROC=512
      PrivateTmp=true
      ProtectSystem=full
      AmbientCapabilities=CAP_NET_BIND_SERVICE

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  notify: restart caddy

- name: Deploy Caddyfile
  template:
    src: "{{ playbook_dir }}/../templates/Caddyfile.j2"
    dest: /etc/caddy/Caddyfile
    owner: caddy
    group: caddy
    mode: '0644'
    validate: '/usr/local/bin/caddy validate --adapter caddyfile --config %s'
  notify: reload caddy

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes

- name: Ensure Caddy service is enabled and started
  systemd:
    name: caddy
    enabled: yes
    state: started
