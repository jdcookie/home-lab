---
# Satisfactory Dedicated Server
# Runs on dedicated Game Server VM (started on-demand)
# Remote access via Tailscale subnet router (LXC 102)
#
# Deployment: Use Ansible playbook
#   ansible-playbook playbooks/deploy-game-server.yml
#
# Or manually:
#   docker compose up -d
#
# Management:
#   Logs:   docker logs -f satisfactory-server
#   Update: docker compose pull && docker compose up -d
#   Stop:   docker compose down

services:
  satisfactory:
    image: wolveix/satisfactory-server:latest
    container_name: satisfactory-server
    hostname: satisfactory
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - MAXPLAYERS=${MAXPLAYERS:-4}
      - SERVERQUERYPORT=${SERVERQUERYPORT:-15777}
      - BEACONPORT=${BEACONPORT:-15000}
      - GAMEPORT=${GAMEPORT:-7777}
      - AUTOPAUSE=${AUTOPAUSE:-true}
      - AUTOSAVEINTERVAL=${AUTOSAVEINTERVAL:-300}
      - CRASHREPORT=${CRASHREPORT:-false}
      - SKIPUPDATE=${SKIPUPDATE:-false}
      - STEAMBETA=${STEAMBETA:-}
    volumes:
      - ${SATISFACTORY_DATA_PATH:-/mnt/games/satisfactory}/config:/config
      - ${SATISFACTORY_DATA_PATH:-/mnt/games/satisfactory}/saves:/config/saves
    # Use host networking for reliable UDP game traffic
    network_mode: host
    restart: unless-stopped
    mem_limit: 12g
    mem_reservation: 8g
    healthcheck:
      test: ["CMD-SHELL", "ss -tuln | grep -q 7777 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 180s
