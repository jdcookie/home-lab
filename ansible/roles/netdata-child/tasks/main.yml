---
# Netdata child installation (streams to parent)

- name: Check if Netdata is installed
  stat:
    path: /usr/sbin/netdata
  register: netdata_installed

- name: Download Netdata kickstart script
  get_url:
    url: https://get.netdata.cloud/kickstart.sh
    dest: /tmp/netdata-kickstart.sh
    mode: '0755'
  when: not netdata_installed.stat.exists

- name: Install Netdata
  shell: /tmp/netdata-kickstart.sh --stable-channel --dont-wait --non-interactive
  args:
    creates: /usr/sbin/netdata
  when: not netdata_installed.stat.exists

- name: Find Netdata config directory
  shell: |
    if [ -d /etc/netdata ]; then echo "/etc/netdata"
    elif [ -d /opt/netdata/etc/netdata ]; then echo "/opt/netdata/etc/netdata"
    else netdata -W buildinfo 2>/dev/null | grep 'Configure' | grep -oP "prefix=\K[^ ]+" | xargs -I{} echo "{}/etc/netdata" || echo "/opt/netdata/etc/netdata"
    fi
  register: netdata_config_dir
  changed_when: false

- name: Display Netdata config directory
  debug:
    msg: "Netdata config directory: {{ netdata_config_dir.stdout }}"

- name: Ensure Netdata config directory exists
  file:
    path: "{{ netdata_config_dir.stdout }}"
    state: directory
    mode: '0755'

- name: Configure Netdata streaming to parent
  template:
    src: stream.conf.j2
    dest: "{{ netdata_config_dir.stdout }}/stream.conf"
    owner: netdata
    group: netdata
    mode: '0640'
  notify: restart netdata-child

- name: Ensure Netdata service is enabled and started
  systemd:
    name: netdata
    enabled: yes
    state: started
